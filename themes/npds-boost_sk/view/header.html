<?php
use App\Support\Forum\Forum;
use App\Support\Auth\Users;
use App\Support\Theme\Theme;
use Npds\Support\Facades\DB;

   $ava='';
   $cha='';
   $bal='';
   $menuser='';

   if (Users::getUser()) {
      $userdata = Forum::get_userdata_from_id(users::cookieUser(0));
      
      $username = Users::cookieUser(1);
      $ibix=explode('+', urldecode(Users::cookieUser(9)));
      $skinname = array_key_exists(1, $ibix) ? $ibix[1] : "default";
   }
   else {
      $skinname = Theme::getSkin();
      $username='';
   }
   switch ($skinname) {
      case 'cyborg':
      case 'solar':
      case 'superhero':
         $headerclasses ='navbar navbar-expand-md navbar-dark bg-dark fixed-top';
      break;
      case 'lumen':
      case 'journal':
      case 'materia':
         $headerclasses ='navbar navbar-expand-md navbar-dark bg-primary fixed-top';
      break;
      case 'simplex':
      case 'litera':
      case 'spacelab':
         $headerclasses ='navbar navbar-expand-md navbar-light bg-light fixed-top';
      break;
      default :
         $headerclasses = 'navbar navbar-expand-md navbar-dark bg-primary fixed-top'; // empty & cerulean cosmo darkly flatly lux minty pulse sandstone slate united yeti default
      break;
   }

   if (Users::autorisation(-1)) {
      $btn_con = '<a class="dropdown-item" href="user.php"><i class="fas fa-sign-in-alt fa-lg me-2 align-middle"></i>'.translate("Connexion").'</a>';
      $ava='<a class="dropdown-item" href="user.php"><i class="fa fa-user fa-3x text-muted"></i></a>';
   }
   elseif (Users::autorisation(1)) {
      
      $nbmes = DB::table('priv_msgs')
                  ->where('to_userid', users::cookieUser(0))
                  ->where('read_msg', 0)
                  ->count();
      vd();
      $cl = $nbmes > 0 ? ' faa-shake animated ' : '';
      
      $menuser .='
                  <li><a class="dropdown-item" href="user.php?op=edituser" title="'.translate("Vous").'"  ><i class="fa fa-user-edit fa-lg me-2"></i>'.translate("Vous").'</a></li>
                  <li><a class="dropdown-item" href="user.php?op=editjournal" title="'.translate("Editer votre journal").'" ><i class="fa fa-edit fa-lg me-2"></i>'.translate("Journal").'</a></li>';
/*
      include_once ("modules/upload/config/upload.conf.php");
      if (($userdata['mns']) and ($autorise_upload_p)) {
         include_once ("modules/blog/upload_minisite.php");
         $Pop=win_upload("popup");
         $menuser .= '
                  <li><a class="dropdown-item" href="javascript:void(0);" onclick="window.open('.$Pop.')" title="'.translate("Gérer votre miniSite").'"><i class="fa fa-desktop fa-lg me-2"></i>'.translate("MiniSite").'</a></li>';
      }
*/
      $menuser .= '
                  <li><a class="dropdown-item " href="user.php?op=edithome" title="'.translate("Editer votre page principale").'" ><i class="fa fa-edit fa-lg me-2 "></i>'.translate("Page").'</a></li>
                  <li><a class="dropdown-item " href="user.php?op=chgtheme" title="'.translate("Changer le thème").'" ><i class="fa fa-paint-brush fa-lg me-2"></i>'.translate("Thème").'</a></li>
                  <li><a class="dropdown-item " href="modules.php?ModPath=reseaux-sociaux&amp;ModStart=reseaux-sociaux" title="'.translate("Réseaux sociaux").'" ><i class="fa fa-share-alt-square fa-lg me-2"></i>'.translate("Réseaux sociaux").'</a></li>
                  <li><a class="dropdown-item " href="viewpmsg.php" title="'.translate("Message personnel").'" ><i class="fa fa-envelope fa-lg me-2 '.$cl.'"></i>'.translate("Message").'</a></li>';

      $res_user = DB::table('users')
                     ->select('user_avatar')
                     ->where('uname', $username)
                     ->first();

      if (!$res_user['user_avatar']) {
         $imgtmp = 'assets/images/forum/avatar/blank.gif';
      } else if (stristr($res_user['user_avatar'], "users_private")) {
         $imgtmp = $res_user['user_avatar'];
      } else {
         if ($ibid=Theme::theme_image("forum/avatar/". $res_user['user_avatar'])) {
            $imgtmp=$ibid;
         } else {
            $imgtmp="assets/images/forum/avatar/". $res_user['user_avatar'];
         }
         
         if (!file_exists($imgtmp)) {
            $imgtmp="assets/images/forum/avatar/blank.gif";
         }
      }

      if ($nbmes > 0)
         $bal = '<li class="nav-item"><a class="nav-link" href="viewpmsg.php"><i class="fa fa-envelope fs-4 faa-shake animated" title="'.translate("Message personnel").' <span class=\'badge rounded-pill bg-danger ms-2\'>'.$nbmes.'</span>" data-bs-html="true" data-bs-toggle="tooltip" data-bs-placement="right"></i></a></li>';

      $ava='<a class="dropdown-item" href="user.php" ><img src="'.$imgtmp.'" class="n-ava-64" alt="avatar" title="'.translate("Votre compte").'" data-bs-toggle="tooltip" data-bs-placement="right" /></a><li class="dropdown-divider"></li>';
      $btn_con='<a class="dropdown-item" href="user.php?op=logout"><i class="fas fa-sign-out-alt fa-lg text-danger me-2"></i>'.translate("Déconnexion").'</a>';
   }
?>

   <nav id="uppernavbar" class=" <?php echo $headerclasses; ?>">
      <div class="container-fluid">
         <a class="navbar-brand" href="index.php" ><span data-bs-toggle="tooltip" data-bs-html="true" data-bs-placement="right" title="&lt;i class='fa fa-home fa-lg' &gt;&lt;/i&gt;">NPDS^ 16</span></a>
         <button href="#" class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#barnav">
            <span class="navbar-toggler-icon"></span>
         </button>
         <div class="collapse navbar-collapse" id="barnav">
            <ul class="navbar-nav">
               <li class="nav-item dropdown"><a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false">News</a>
                  <ul class="dropdown-menu" role="menu">
                     <li><a class="dropdown-item" href="index.php?op=index.php">[fr]Les articles[/fr][en]Stories[/en][zh]&#x6587;&#x7AE0;[/zh][es]Art&#xED;culo[/es][de]Artikeln[/de]</a></li>
                     <li><a class="dropdown-item" href="search.php">[fr]Les archives[/fr][en]Archives[/en][zh]&#x6863;&#x6848;&#x9986;[/zh][es]Los archivos[/es][de]Die Archive[/de]</a></li>
                     <li><a class="dropdown-item" href="submit.php">[fr]Soumettre un article[/fr][en]Submit a New[/en][zh]&#x63D0;&#x8BAE;&#x51FA;&#x7248;&#x4E00;&#x4EFD;&#x51FA;&#x7248;&#x7269;[/zh][es]Enviar un artículo[/es][de]Publikation vorschlagen[/de]</a></li>
                  </ul>
               </li>
               <li class="nav-item"><a class="nav-link" href="forum.php">[fr]Forums[/fr][en]Forums[/en][zh]&#x7248;&#x9762;&#x7BA1;&#x7406;[/zh][es]Foros[/es][de]Foren[/de]</a></li>
               <li class="nav-item"><a class="nav-link" href="download.php">[fr]T&eacute;l&eacute;chargements[/fr][en]Downloads[/en][zh]Downloads[/zh][es]Descargas[/es][de]Downloads[/de]</a></li>
               <li class="nav-item"><a class="nav-link" href="modules.php?ModPath=links&amp;ModStart=links">[fr]Liens[/fr][en]Links[/en][zh]&#x7F51;&#x9875;&#x94FE;&#x63A5;[/zh][es]Enlaces web[/es][de]Internetlinks[/de]</a></li>
               <li class="nav-item dropdown">
                  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown"><i class="fa fa-user fa-lg"></i>&nbsp;<?php echo $username; ?></a>
                  <ul class="dropdown-menu">
                     <li><?php echo $ava; ?></li>
                     <?php echo $menuser; ?>
                     <li class="dropdown-divider"></li>
                     <li><?php echo $btn_con; ?></li>
                  </ul>
               </li>
               <?php echo $bal; ?>
            </ul>
         </div>
      </div>
   </nav>
   <div class="page-header">
      <div class="row">
      <div class="col-sm-2"><img class="img-fluid" src="themes/!theme!/assets/images/header.png" alt="image_entete" /></div>
         <div id="logo_header" class="col-sm-6">
            <h1 class="my-4">NPDS<br /><small class="text-muted">Responsive</small></h1>
         </div>
         <div id="ban" class="col-sm-4 text-end">!banner!</div>
      </div>
      <div class="row">
         <div id="slogan" class="col-sm-8 text-muted slogan"><strong>!slogan!</strong></div>
         <div id="online" class="col-sm-4 text-muted text-end">!nb_online!</div>
      </div>
   </div>
   <script type="text/javascript">
   //<![CDATA[
      $(document).ready(function() {
      var chat_pour=['chat_tous','chat_membres','chat_anonyme','chat_admin'];
      chat_pour.forEach(function(ele) {
         if ($('#'+ele+'_encours').length) {
            var clon = $('#'+ele+'_encours').clone()
            .attr('id',ele+'_ico');
            $( ".navbar-nav" ).append( clon );
            $('#'+ele+'_ico').wrapAll('<li class="nav-item" />');
         }
      })
      })
   //]]>
   </script>
